---
- name: Déployer API Node.js sur VM Ubuntu
  hosts: api_servers
  become: yes
  vars:
    api_repo_url: "https://github.com/HichOps/integration-deploy-ynov.git"
    api_dir: "/home/ubuntu"
    backend_dir: "{{ api_dir }}/integration-deploy-ynov/api/backend"

  tasks:
    - name: Mettre à jour les paquets apt
      apt:
        update_cache: yes
        upgrade: dist

    - name: Installer dépendances de base
      apt:
        name:
          - curl
          - git
          - build-essential
        state: present

    - name: Installer Node.js (setup LTS)
      shell: curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
      args:
        executable: /bin/bash
      register: nodejs_setup
      changed_when: "'deb.nodesource.com' in nodejs_setup.stdout"

    - name: Installer nodejs
      apt:
        name: nodejs
        state: present
      when: nodejs_setup.changed

    - name: Cloner le repo API (ou pull si déjà présent)
      git:
        repo: "{{ api_repo_url }}"
        dest: "{{ api_dir }}/integration-deploy-ynov"
        version: main
        force: yes
        update: yes
        accept_hostkey: yes
      become_user: ubuntu

    - name: Vérifier que package.json existe dans backend
      stat:
        path: "{{ backend_dir }}/package.json"
      register: package_json

    - name: Afficher la présence du package.json
      debug:
        msg: "package.json présent ? {{ package_json.stat.exists }}"

    - name: Afficher la liste des fichiers dans backend
      command: ls -l "{{ backend_dir }}"
      register: list_backend_dir
      become_user: ubuntu

    - debug:
        var: list_backend_dir.stdout_lines

    - name: Installer les dépendances Node.js
      npm:
        path: "{{ backend_dir }}"
        production: yes
      when: package_json.stat.exists
      become_user: ubuntu

    - name: Redémarrer l'API si elle est déjà démarrée
      shell: pm2 restart api
      become_user: ubuntu
      ignore_errors: true

    - name: Installer pm2 globalement
      npm:
        name: pm2
        global: yes

    - name: Lancer l'API avec pm2
      shell: pm2 start index.js --name api --cwd "{{ backend_dir }}" --update-env
      args:
        creates: /home/ubuntu/.pm2/pids/api.pid
      become_user: ubuntu

    - name: Configurer pm2 au démarrage système
      shell: |
        env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu
      become: yes

    - name: Sauvegarder la configuration pm2
      shell: pm2 save
      become_user: ubuntu
