---
- name: Déployer API Node.js sur VM Ubuntu
  hosts: api_servers
  become: yes
  vars:
    api_repo_url: "https://github.com/HichOps/integration-deploy-ynov.git"
    api_base_dir: "/home/ubuntu/integration-deploy-ynov"
    backend_dir: "{{ api_base_dir }}/api/backend"
    node_version_setup_script: "https://deb.nodesource.com/setup_lts.x"
    sqlite_db_path: "{{ backend_dir }}/database.sqlite"

  tasks:
    - name: Mettre à jour la liste des paquets et faire un upgrade
      apt:
        update_cache: yes
        upgrade: dist

    - name: Installer dépendances de base
      apt:
        name:
          - curl
          - git
          - build-essential
          - python3-pip
        state: present

    - name: Installer Node.js LTS via script officiel
      shell: curl -fsSL {{ node_version_setup_script }} | bash -
      args:
        executable: /bin/bash
      register: nodejs_setup
      changed_when: "'deb.nodesource.com' in nodejs_setup.stdout"

    - name: Installer nodejs
      apt:
        name: nodejs
        state: present
      when: nodejs_setup.changed

    - name: Installer SQLite3
      apt:
        name: sqlite3
        state: present

    - name: Vérifier que le module npm sqlite est installé (si utilisé dans le projet)
      npm:
        name: sqlite3
        path: "{{ backend_dir }}"
        production: yes
      become_user: ubuntu

    - name: Installer pm2 globalement via npm
      npm:
        name: pm2
        global: yes

    - name: Cloner ou mettre à jour le repo API
      git:
        repo: "{{ api_repo_url }}"
        dest: "{{ api_base_dir }}"
        version: main
        force: yes
        update: yes
        accept_hostkey: yes
      become_user: ubuntu

    - name: "=== Début installation des dépendances Node.js backend ==="
      debug:
        msg: "Début installation des dépendances npm"

    - name: Installer les dépendances Node.js backend (avec timeout 5 min)
      npm:
        path: "{{ backend_dir }}"
        production: yes
      become_user: ubuntu
      async: 300
      poll: 0
      register: npm_job

    - name: "Attendre la fin de l'installation npm"
      async_status:
        jid: "{{ npm_job.ansible_job_id }}"
      register: npm_job_result
      until: npm_job_result.finished
      retries: 30
      delay: 10

    - name: "=== Début initialisation de la base SQLite ==="
      debug:
        msg: "Début initialisation de la base SQLite avec le script Node.js"

    - name: Initialiser la base de données SQLite avec le script Node.js (timeout 1 min)
      shell: node app/scripts/initDB.js
      args:
        chdir: "{{ backend_dir }}"
      become_user: ubuntu
      async: 60
      poll: 0
      register: initdb_job

    - name: "Attendre la fin du script initDB.js"
      async_status:
        jid: "{{ initdb_job.ansible_job_id }}"
      register: initdb_job_result
      until: initdb_job_result.finished
      retries: 12
      delay: 5

    - name: Vérifier si pm2 a déjà l’API démarrée
      shell: pm2 describe api
      register: pm2_api_status
      ignore_errors: yes
      become_user: ubuntu

    - name: Redémarrer l'API si déjà démarrée sinon la démarrer
      shell: |
        if [[ {{ pm2_api_status.rc }} -eq 0 ]]; then
          pm2 restart api
        else
          pm2 start index.js --name api --cwd "{{ backend_dir }}" --update-env
        fi
      args:
        executable: /bin/bash
      become_user: ubuntu

    - name: Configurer pm2 pour démarrage automatique au boot
      shell: |
        env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu
      become: yes

    - name: Sauvegarder la configuration pm2
      shell: pm2 save
      become_user: ubuntu